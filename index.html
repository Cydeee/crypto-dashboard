<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Crypto Swing-Trade Dashboard (Blocks Aâ€“E)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- Tailwind v3 CDN -->
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 text-[13px] leading-5">
<div class="max-w-7xl mx-auto p-4 space-y-8">

  <header>
    <h1 class="text-2xl font-bold">Yolo Dashboard</h1>
  </header>

  <!-- *** BLOCK A *** -->
  <section id="blockA" class="space-y-4">
    <h2 class="text-xl font-semibold">ğŸŸ¦ Block A Â· Price / Volatility / Trend</h2>
    <div id="A-cards" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4"></div>
  </section>

  <!-- *** BLOCK B *** -->
  <section id="blockB" class="space-y-2">
    <h2 class="text-xl font-semibold">ğŸŸ¨ Block B Â· Derivatives Positioning</h2>
    <table class="w-full text-left bg-white rounded shadow" id="tblB">
      <thead class="bg-slate-100">
        <tr><th class="p-1">Metric</th><th class="p-1">Value</th></tr>
      </thead><tbody></tbody>
    </table>
  </section>

  <!-- *** BLOCK C *** -->
  <section id="blockC" class="space-y-2">
    <h2 class="text-xl font-semibold">ğŸŸ¥ Block C Â· Liquidations</h2>
    <table class="w-full text-left bg-white rounded shadow" id="tblC">
      <thead class="bg-slate-100">
        <tr><th class="p-1">Last 1 h</th><th class="p-1">Long $</th><th class="p-1">Short $</th></tr>
      </thead><tbody></tbody>
    </table>
  </section>

  <!-- *** BLOCK D *** -->
  <section id="blockD" class="space-y-2">
    <h2 class="text-xl font-semibold">ğŸŸª Block D Â· Sentiment / Community</h2>
    <table class="w-full text-left bg-white rounded shadow" id="tblD">
      <thead class="bg-slate-100">
        <tr><th class="p-1">Metric</th><th class="p-1">Value</th></tr>
      </thead><tbody></tbody>
    </table>
  </section>

  <!-- *** BLOCK E *** -->
  <section id="blockE" class="space-y-2">
    <h2 class="text-xl font-semibold">ğŸŸ« Block E Â· Macro Risk Context</h2>
    <table class="w-full text-left bg-white rounded shadow" id="tblE">
      <thead class="bg-slate-100">
        <tr><th class="p-1">Metric</th><th class="p-1">Value</th></tr>
      </thead><tbody></tbody>
    </table>
  </section>

  <footer id="status" class="text-gray-500"></footer>
</div>

<script>
/* ========== 0 Â· KEYS & CONSTANTS ========== */
const COIN        = 'BTC';                       // CoinGlass symbol base
const CG_ID       = 'bitcoin';                   // CoinGecko slug
const SYMBOL_FH   = 'BINANCE:BTCUSDT';           // Finnhub symbol
const TOKEN_FH    = 'YOUR_FINNHUB_KEY';          // <<< PUT YOUR FINNHUB KEY
const TOKEN_AV    = 'YOUR_ALPHA_VANTAGE_KEY';    // <<< PUT YOUR ALPHA KEY

/* Robust CORS proxy for CoinGlass */
const CG_PROXY = path =>
  `https://cors.isomorphic-git.org/${encodeURIComponent('https://open-api.coinglass.com'+path)}`;

/* poll intervals (ms) */
const CADENCE = { A:60_000, B:120_000, C:120_000, D:180_000, E:300_000 };

/* ========== 1 Â· HELPERS ========== */
const byId = id => document.getElementById(id);
function fmt(x,p=2){ return x==null ? 'âš ï¸' : (+x).toFixed(p); }
function setCell(tbl,key,val){
  let row = tbl.querySelector(`tr[data-k="${key}"]`);
  if(!row){
    row = document.createElement('tr'); row.dataset.k = key;
    row.innerHTML = `<td class="p-1">${key}</td><td class="p-1" data-v></td>`;
    tbl.querySelector('tbody').appendChild(row);
  }
  row.querySelector('[data-v]').textContent = val;
}
function badge(val,pos,neg){ return val==null ? 'âš ï¸' : (val>0?`${val}${pos}`:`${val}${neg}`); }

/* ========== 2 Â· BUILD BLOCK A CARDS ========== */
const TF = { '15m':15, '1h':60, '4h':240, '1d':'D' };
const wrapA = byId('A-cards');
for(const t in TF){
  wrapA.insertAdjacentHTML('beforeend',`
    <div id="card-${t}" class="bg-white rounded shadow p-3 space-y-1">
      <h3 class="font-medium mb-1">${t}</h3>
      <div>EMA50 <span id="${t}-ema50">â€¦</span></div>
      <div>EMA200 <span id="${t}-ema200">â€¦</span></div>
      <div>RSI-14 <span id="${t}-rsi">â€¦</span></div>
      <div>BB width % <span id="${t}-bb">â€¦</span></div>
      <div>ATR/Close % <span id="${t}-atr">â€¦</span></div>
    </div>`);
}

/* ========== 3 Â· BLOCK A FETCH ========== */
async function fhIndic(ind,res,extra={}){
  const url = new URL('https://finnhub.io/api/v1/indicator');
  const now = Math.floor(Date.now()/1000);
  url.searchParams.set('symbol',SYMBOL_FH);
  url.searchParams.set('resolution',res);
  url.searchParams.set('indicator',ind);
  url.searchParams.set('from',now-10_000);
  url.searchParams.set('to',now);
  url.searchParams.set('token',TOKEN_FH);
  Object.entries(extra).forEach(([k,v])=>url.searchParams.set(k,v));
  return (await fetch(url)).json();
}
async function pullA(){
  for(const [name,res] of Object.entries(TF)){
    try{
      const [ema50J, ema200J, rsiJ, bbJ, atrJ] = await Promise.all([
        fhIndic('ema',res,{timeperiod:50}),
        fhIndic('ema',res,{timeperiod:200}),
        fhIndic('rsi',res,{timeperiod:14}),
        fhIndic('bbands',res,{timeperiod:20}),
        fhIndic('atr',res,{timeperiod:14})
      ]);
      const ema50 = ema50J?.EMA?.at(-1);
      const ema200= ema200J?.EMA?.at(-1);
      const rsi   = rsiJ?.RSI?.at(-1);
      const up = bbJ?.upper?.at(-1), low = bbJ?.lower?.at(-1), close = bbJ?.close?.at(-1);
      const bbW   = up&&low&&close ? (((up-low)/close)*100).toFixed(2) : null;
      const atr   = atrJ?.ATR?.at(-1);
      const atrP  = atr&&close ? ((atr/close)*100).toFixed(2) : null;

      ['ema50','ema200','rsi','bb','atr'].forEach((k,i)=>{
        const v=[ema50,ema200,rsi,bbW,atrP][i];
        byId(`${name}-${k}`).textContent = fmt(v,k==='rsi'?1:2);
      });
    }catch(e){ console.error('Block A',e); }
  }
}

/* ========== 4 Â· BLOCK B Â· Derivatives ========== */
async function pullB(){
  try{
    const fr = await fetch(CG_PROXY(`/api/futures/funding_rates/v2?symbol=${COIN}`)).then(r=>r.json());
    const oi = await fetch(CG_PROXY(`/api/futures/open_interest/v2?symbol=${COIN}`)).then(r=>r.json());
    const frVal = fr?.data?.[0]?.fundingRate;
    const frZ   = fr?.data?.[0]?.fundingRateZScore;
    const oiPct = oi?.data?.[0]?.open_interest_change_24h;
    setCell(byId('tblB'),'Funding rate', fmt(frVal,4));
    setCell(byId('tblB'),'Funding z-score', badge(fmt(frZ,2),' âš  crowd',' âš  crowd'));
    setCell(byId('tblB'),'Open-interest %Î”', badge(fmt(oiPct,1),' â†‘',' â†“'));
  }catch(e){ console.error('Block B',e); }
}

/* ========== 5 Â· BLOCK C Â· Liquidations ========== */
async function pullC(){
  try{
    const url  = CG_PROXY(`/api/futures/liquidations/v2?symbol=${COIN}USDT&interval=1h`);
    const data = await fetch(url).then(r=>r.json());
    const last = data?.data?.slice(-1)[0];
    const tbody= byId('tblC').querySelector('tbody');
    tbody.innerHTML='';
    if(last){
      tbody.innerHTML = `<tr>
        <td class="p-1">${new Date(last.timestamp).toLocaleTimeString()}</td>
        <td class="p-1 text-rose-600">${fmt(last.long_liq_usd,0)}</td>
        <td class="p-1 text-emerald-600">${fmt(last.short_liq_usd,0)}</td></tr>`;
    }
  }catch(e){ console.error('Block C',e); }
}

/* ========== 6 Â· BLOCK D Â· Sentiment ========== */
async function pullD(){
  try{
    const d = await fetch(`https://api.coingecko.com/api/v3/coins/${CG_ID}`).then(r=>r.json());
    setCell(byId('tblD'),'Sentiment votes %', fmt(d?.sentiment_votes_up_percentage,1));
    setCell(byId('tblD'),'Community score',     fmt(d?.community_score,1));
    setCell(byId('tblD'),'Reddit posts 48 h',   d.community_data?.reddit_posts_48h ?? 'âš ï¸');
  }catch(e){ console.error('Block D',e); }
}

/* ========== 7 Â· BLOCK E Â· Macro ========== */
const AV = q => `https://www.alphavantage.co/query?${q}&apikey=${TOKEN_AV}`;
async function pullE(){
  try{
    const [qqq, btc, dxy, vix, tip] = await Promise.all([
      fetch(AV('function=TIME_SERIES_INTRADAY&symbol=QQQ&interval=30min')).then(r=>r.json()),
      fetch(AV('function=CRYPTO_INTRADAY&symbol=BTC/USD&interval=60min')).then(r=>r.json()),
      fetch(AV('function=FX_DAILY&from_symbol=USD&to_symbol=DXY')).then(r=>r.json()),
      fetch(AV('function=TIME_SERIES_DAILY&symbol=VIXY')).then(r=>r.json()),
      fetch(AV('function=TIME_SERIES_DAILY&symbol=TIP')).then(r=>r.json())
    ]);
    const q30 = Object.values(qqq['Time Series (30min)']||{}).slice(0,2).map(o=>+o['4. close']);
    const qPct= q30.length===2 ? (((q30[0]-q30[1])/q30[1])*100).toFixed(2) : null;
    const btc60= Object.values(btc['Time Series Crypto (60min)']||{}).slice(0,10).map(o=>+o['4. close']);
    const qqq60= Object.values(qqq['Time Series (30min)']||{}).slice(0,10).map(o=>+o['4. close']);
    const corr = (btc60.length===qqq60.length) ? pearson(btc60,qqq60).toFixed(2) : null;
    function z(series){
      const xs = Object.values(series).slice(0,30).map(o=>+o['4. close']);
      const m  = xs.reduce((a,b)=>a+b,0)/xs.length;
      const sd = Math.sqrt(xs.reduce((s,x)=>s+(x-m)**2,0)/xs.length);
      return xs.length?((xs[0]-m)/sd).toFixed(2):null;
    }
    const dxyZ = z(dxy['Time Series FX (Daily)']||{});
    const vixZ = z(vix['Time Series (Daily)']||{});
    const tipTwo = Object.values(tip['Time Series (Daily)']||{}).slice(0,2).map(o=>+o['4. close']);
    const tipPct = tipTwo.length===2?(((tipTwo[0]-tipTwo[1])/tipTwo[1])*100).toFixed(2):null;

    const tbl = byId('tblE');
    setCell(tbl,'QQQ 30 min %Î”', badge(qPct,' â†‘',' â†“'));
    setCell(tbl,'BTC-QQQ corr Ï' , fmt(corr,2));
    setCell(tbl,'DXY z-score',     badge(dxyZ,' â†‘',' â†“'));
    setCell(tbl,'VIXY z-score',    badge(vixZ,' â†‘',' â†“'));
    setCell(tbl,'TIP 1-day %Î”',    badge(tipPct,' â†‘',' â†“'));
  }catch(e){ console.error('Block E',e); }
}
function pearson(x,y){
  const n=x.length, mx=x.reduce((a,b)=>a+b)/n, my=y.reduce((a,b)=>a+b)/n;
  const num=x.reduce((s,xi,i)=>s+(xi-mx)*(y[i]-my),0);
  const den=Math.sqrt(x.reduce((s,xi)=>s+(xi-mx)**2,0)*y.reduce((s,yi)=>s+(yi-my)**2,0));
  return num/den;
}

/* ========== 8 Â· START LOOPS ========== */
pullA(); pullB(); pullC(); pullD(); pullE();
setInterval(pullA, CADENCE.A);
setInterval(pullB, CADENCE.B);
setInterval(pullC, CADENCE.C);
setInterval(pullD, CADENCE.D);
setInterval(pullE, CADENCE.E);
setInterval(()=>byId('status').textContent='Last refresh '+new Date().toLocaleTimeString(),1000);
</script>
</body>
</html>
