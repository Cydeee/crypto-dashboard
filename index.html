<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Crypto Swing-Trade Dashboard (Blocks A–E)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Tailwind v3 CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-50 text-[13px] leading-5">
<div class="max-w-7xl mx-auto p-4 space-y-8">

  <header><h1 class="text-2xl font-bold">Yolo Dashboard</h1></header>

  <!-- Block A -->
  <section id="blockA" class="space-y-4">
    <h2 class="text-xl font-semibold">🟦 Block A · Price / Volatility / Trend</h2>
    <div id="A-cards" class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4"></div>
  </section>

  <!-- Block B -->
  <section id="blockB" class="space-y-2">
    <h2 class="text-xl font-semibold">🟨 Block B · Derivatives Positioning</h2>
    <table id="tblB" class="w-full text-left bg-white rounded shadow">
      <thead class="bg-slate-100"><tr><th class="p-1">Metric</th><th class="p-1">Value</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Block C -->
  <section id="blockC" class="space-y-2">
    <h2 class="text-xl font-semibold">🟥 Block C · Liquidations</h2>
    <table id="tblC" class="w-full text-left bg-white rounded shadow">
      <thead class="bg-slate-100"><tr><th class="p-1">Last 1 h</th><th class="p-1">Long $</th><th class="p-1">Short $</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Block D -->
  <section id="blockD" class="space-y-2">
    <h2 class="text-xl font-semibold">🟪 Block D · Sentiment / Community</h2>
    <table id="tblD" class="w-full text-left bg-white rounded shadow">
      <thead class="bg-slate-100"><tr><th class="p-1">Metric</th><th class="p-1">Value</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Block E -->
  <section id="blockE" class="space-y-2">
    <h2 class="text-xl font-semibold">🟫 Block E · Macro Risk Context</h2>
    <table id="tblE" class="w-full text-left bg-white rounded shadow">
      <thead class="bg-slate-100"><tr><th class="p-1">Metric</th><th class="p-1">Value</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <footer id="status" class="text-gray-500"></footer>
</div>

<script>
/* 0 · KEYS & CONSTANTS */
const COIN      = 'BTC';
const CG_ID     = 'bitcoin';
const SYMBOL_FH = 'BINANCE:BTCUSDT';
const TOKEN_FH  = 'd1t6tipr01qh0t056ib0d1t6tipr01qh0t056ibg';
const TOKEN_AV  = 'AACLL7F0LSZ38PTB';

/* CoinGlass CORS proxy */
const CG_PROXY = path =>
  `https://cors.isomorphic-git.org/${encodeURIComponent('https://open-api.coinglass.com'+path)}`;

/* Poll cadence (ms) */
const CADENCE = { A:60000, B:120000, C:120000, D:180000, E:300000 };

/* Helpers */
const byId = id => document.getElementById(id);
const fmt  = (x,p=2)=>x==null?'⚠️':(+x).toFixed(p);
const badge=(v,pos,neg)=>v==null?'⚠️':v>0?`${v}${pos}`:`${v}${neg}`;
function setCell(tbl,key,val){
  let row=tbl.querySelector(`tr[data-k="${key}"]`);
  if(!row){
    row=document.createElement('tr');row.dataset.k=key;
    row.innerHTML=`<td class="p-1">${key}</td><td class="p-1" data-v></td>`;
    tbl.querySelector('tbody').appendChild(row);
  }
  row.querySelector('[data-v]').textContent=val;
}

/* 1 · Build Block A cards */
const TF = {'15m':15,'1h':60,'4h':240,'1d':'D'};
const wrapA=byId('A-cards');
for(const t in TF){
  wrapA.insertAdjacentHTML('beforeend',`
    <div class="bg-white rounded shadow p-3 space-y-1">
      <h3 class="font-medium mb-1">${t}</h3>
      <div>EMA50 <span id="${t}-ema50">…</span></div>
      <div>EMA200 <span id="${t}-ema200">…</span></div>
      <div>RSI-14 <span id="${t}-rsi">…</span></div>
      <div>BB width % <span id="${t}-bb">…</span></div>
      <div>ATR/Close % <span id="${t}-atr">…</span></div>
    </div>`);
}

/* 2 · Finnhub indicator helper */
async function fh(ind,res,extra={}){
  const url=new URL('https://finnhub.io/api/v1/indicator');
  const now=Math.floor(Date.now()/1000);
  url.searchParams.set('symbol',SYMBOL_FH);
  url.searchParams.set('resolution',res);
  url.searchParams.set('indicator',ind);
  url.searchParams.set('from',now-10000);
  url.searchParams.set('to',now);
  url.searchParams.set('token',TOKEN_FH);
  Object.entries(extra).forEach(([k,v])=>url.searchParams.set(k,v));
  const r=await fetch(url);
  return r.ok?r.json():{};
}

/* 3 · Block A poll */
async function pollA(){
  for(const [tf,res] of Object.entries(TF)){
    try{
      const [e50,e200,rsi,bb,atr]=await Promise.all([
        fh('ema',res,{timeperiod:50}),
        fh('ema',res,{timeperiod:200}),
        fh('rsi',res,{timeperiod:14}),
        fh('bbands',res,{timeperiod:20}),
        fh('atr',res,{timeperiod:14})
      ]);
      const ema50=e50.EMA?.at(-1),
            ema200=e200.EMA?.at(-1),
            rsiV=rsi.RSI?.at(-1),
            up=bb.upper?.at(-1),low=bb.lower?.at(-1),close=bb.close?.at(-1),
            bbW=up&&low&&close?(((up-low)/close)*100).toFixed(2):null,
            atrV=atr.ATR?.at(-1),
            atrP=atrV&&close?((atrV/close)*100).toFixed(2):null;

      [['ema50',ema50],['ema200',ema200],['rsi',rsiV],['bb',bbW],['atr',atrP]]
        .forEach(([k,v])=>byId(`${tf}-${k}`).textContent=fmt(v,k==='rsi'?1:2));
    }catch(e){console.error('A',e);}
  }
}

/* 4 · Block B */
async function pollB(){
  try{
    const fr=await fetch(CG_PROXY(`/api/futures/funding_rates/v2?symbol=${COIN}`)).then(r=>r.json());
    const oi=await fetch(CG_PROXY(`/api/futures/open_interest/v2?symbol=${COIN}`)).then(r=>r.json());
    setCell(byId('tblB'),'Funding rate',      fmt(fr?.data?.[0]?.fundingRate,4));
    setCell(byId('tblB'),'Funding z-score',   badge(fmt(fr?.data?.[0]?.fundingRateZScore,2),' ⚠',' ⚠'));
    setCell(byId('tblB'),'Open-interest %Δ',  badge(fmt(oi?.data?.[0]?.open_interest_change_24h,1),' ↑',' ↓'));
  }catch(e){console.error('B',e);}
}

/* 5 · Block C */
async function pollC(){
  try{
    const d=await fetch(CG_PROXY(`/api/futures/liquidations/v2?symbol=${COIN}USDT&interval=1h`)).then(r=>r.json());
    const last=d?.data?.at(-1);
    const tb=byId('tblC').querySelector('tbody');tb.innerHTML='';
    if(last){
      tb.innerHTML=`<tr><td class="p-1">${new Date(last.timestamp).toLocaleTimeString()}</td>
        <td class="p-1 text-rose-600">${fmt(last.long_liq_usd,0)}</td>
        <td class="p-1 text-emerald-600">${fmt(last.short_liq_usd,0)}</td></tr>`;
    }
  }catch(e){console.error('C',e);}
}

/* 6 · Block D */
async function pollD(){
  try{
    const d=await fetch(`https://api.coingecko.com/api/v3/coins/${CG_ID}`).then(r=>r.json());
    setCell(byId('tblD'),'Sentiment votes %', fmt(d?.sentiment_votes_up_percentage,1));
    setCell(byId('tblD'),'Community score',   fmt(d?.community_score,1));
    setCell(byId('tblD'),'Reddit posts 48 h', d?.community_data?.reddit_posts_48h ?? '⚠️');
  }catch(e){console.error('D',e);}
}

/* 7 · Block E helpers */
const AV=q=>`https://www.alphavantage.co/query?${q}&apikey=${TOKEN_AV}`;
function zscore(series){
  const xs=Object.values(series).slice(0,30).map(o=>+o['4. close']);
  if(!xs.length)return null;
  const m=xs.reduce((a,b)=>a+b)/xs.length;
  const sd=Math.sqrt(xs.reduce((s,x)=>s+(x-m)**2,0)/xs.length);
  return ((xs[0]-m)/sd).toFixed(2);
}
function pearson(x,y){
  const n=x.length,mx=x.reduce((a,b)=>a+b)/n,my=y.reduce((a,b)=>a+b)/n;
  const num=x.reduce((s,xi,i)=>s+(xi-mx)*(y[i]-my),0);
  const den=Math.sqrt(x.reduce((s,xi)=>s+(xi-mx)**2,0)*y.reduce((s,yi)=>s+(yi-my)**2,0));
  return num/den;
}
async function pollE(){
  try{
    const [qqq,btc,dxy,vix,tip]=await Promise.all([
      fetch(AV('function=TIME_SERIES_INTRADAY&symbol=QQQ&interval=30min')).then(r=>r.json()),
      fetch(AV('function=CRYPTO_INTRADAY&symbol=BTC/USD&interval=60min')).then(r=>r.json()),
      fetch(AV('function=FX_DAILY&from_symbol=USD&to_symbol=DXY')).then(r=>r.json()),
      fetch(AV('function=TIME_SERIES_DAILY&symbol=VIXY')).then(r=>r.json()),
      fetch(AV('function=TIME_SERIES_DAILY&symbol=TIP')).then(r=>r.json())
    ]);

    const q30=Object.values(qqq['Time Series (30min)']||{}).slice(0,2).map(o=>+o['4. close']);
    const qPct=q30.length===2?(((q30[0]-q30[1])/q30[1])*100).toFixed(2):null;
    const btc60=Object.values(btc['Time Series Crypto (60min)']||{}).slice(0,10).map(o=>+o['4. close']);
    const qqq60=Object.values(qqq['Time Series (30min)']||{}).slice(0,10).map(o=>+o['4. close']);
    const corr=(btc60.length===qqq60.length)?pearson(btc60,qqq60).toFixed(2):null;
    const dxyZ=zscore(dxy['Time Series FX (Daily)']||{});
    const vixZ=zscore(vix['Time Series (Daily)']||{});
    const tipTwo=Object.values(tip['Time Series (Daily)']||{}).slice(0,2).map(o=>+o['4. close']);
    const tipPct=tipTwo.length===2?(((tipTwo[0]-tipTwo[1])/tipTwo[1])*100).toFixed(2):null;

    const tbl=byId('tblE');
    setCell(tbl,'QQQ 30 min %Δ',badge(qPct,' ↑',' ↓'));
    setCell(tbl,'BTC-QQQ corr ρ',fmt(corr,2));
    setCell(tbl,'DXY z-score',     badge(dxyZ,' ↑',' ↓'));
    setCell(tbl,'VIXY z-score',    badge(vixZ,' ↑',' ↓'));
    setCell(tbl,'TIP 1-day %Δ',    badge(tipPct,' ↑',' ↓'));
  }catc

